$().ready(function(){uploader=new fileUploadAction;uploader.apply($("#requirement-images").find(".image-input"));$(".autosave").autosave({url:$("#autosave-url").val(),method:"POST",event:"change",done:function(data){if($(this).attr("data-cancel")=="cancel"){window.location.replace("/admin/commissions")}}})});function fileUploadAction(){this.apply=function(file_input){var iframe_fallback=false;var this_file_input=file_input;var image_data={};var forms_div=this_file_input.closest(".image-upload-div").find(".image-forms");this_file_input.closest(".image-upload-div").find(".progress").hide();this_file_input.closest(".image-upload-div").find(".image-forms");this_file_input.fileupload({dataType:"json",url:$("#upload-url").val(),submit:function(e,data){var data_form=forms_div.find(".data-form");data.formData=getFormData(data_form);image_data=data.formData;image_data["commission_id"]=$(forms_div).find(".commission-id").val()},send:function(e,data){if(data.dataType.indexOf("iframe")>=0){iframe_fallback=true}if(data.files[0].name.length>0){if(iframe_fallback){setTimeout(function(){loadImage(image_data)},1e4)}else{$("#progress-bar-"+image_data.commission_id).css("width","0%");$("#progress-"+image_data.commission_id).show()}forms_div.hide()}},progress:function(e,data){var progress=parseInt(data.loaded/data.total*95,10);$("#progress-bar-"+image_data.commission_id).css("width",progress+"%")},done:function(e,data){if(!iframe_fallback){loadImage(image_data)}},always:function(e,data){$("#progress-"+image_data.commission_id).hide();forms_div.show()}})}}function getFormData(form){var form_data={};$.ajax({async:false,cache:false,type:form.attr("method"),url:form.attr("action"),data:form.serialize(),dataType:"json",success:function(data){form_data=data}});return form_data}function loadImage(image_data){$.ajax({async:false,url:$("#upload-check-url").val(),cache:false,data:image_data,dataType:"json"}).done(function(data,textStatus,jqXHR){switch(jqXHR.status){case 200:$("#image-"+image_data.commission_id).find("img").attr("src",data.thumb_url);$("#progress-"+image_data.commission_id).hide();$("#image-forms-"+image_data.commission_id).show();break;case 204:setTimeout(function(){loadImage(image_data)},2e3);case 404:break}}).fail(function(){})}