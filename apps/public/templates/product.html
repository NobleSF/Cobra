{% extends "base.html" %}
{% load url from future %}
{% load cache %}

{% cache 86400 public_product_header product.id product.is_approved product.is_sold %}

{% block title %}{# 70 chars or less #}
  {{ product.title }} | Fair Trade {{ product.seller.country.name }} Anou
{% endblock title %}

{% block description %}{# 160 chars or less #}
  {{ product.title_description }}
{% endblock description %}

{%block open_graph_type%}product{%endblock%}
{%block open_graph_url%}{{ product.get_absolute_url }}{%endblock%}
{%block open_graph_title%}{{ product.standard_title }}{%endblock%}
{%block open_graph_description%}{{ product.description }}{%endblock%}
{%block open_graph_image%}{{ product.photos.0.original }}{%endblock%}
{%block open_graph_price%}{{ product.display_price }}{%endblock%}
{%block open_graph_upc%}{{ product.id }}{%endblock%}
{%block open_graph_availability%}{% if product.is_sold or not product.is_approved %}out of stock{% else %}in stock{% endif %}{%endblock%}

{% block additional_meta_tags %}
  <meta property="product:price:amount"           content="{{ product.display_price }}" />
  <meta property="product:price:currency"         content="USD" />
  <meta property="product:shipping_cost:amount"   content="{{ product.display_shipping_price }}" />
  <meta property="product:shipping_cost:currency" content="USD" />
{% endblock additional_meta_tags %}

{% block javascript %}
  <script type="text/javascript" src="{{ STATIC_URL }}public/js/product.min.js"></script>
{% endblock javascript %}

{% block css %}
  <link href="{{ STATIC_URL }}public/css/product.css" rel="stylesheet">
{% endblock css %}
{% endcache public_product_header %}

{% block header_link_1 %}
  {{ block.super }}
{% endblock header_link_1 %}
{% block header_link_2 %}
  {{ block.super }}
  {% if 'admin_id' in request.session %}
    <li><button id='unapprove' class='btn btn-warning'
            data-approve-url="{% url 'admin:approve product' %}"
            data-product-id="{{ product.id }}">
      {% if product.approved_at %}
        Unapprove Product
      {% else %}
        Unapproved.
      {% endif %}
    </button></li>
    <li><a href="{% url 'admin:rebuild productpage' product.id %}">
      <button class='btn'>Refresh-Cache</button>
    </a></li>
  {% endif %}
{% endblock header_link_2 %}

{% block content %}
{% cache 86400 public_product_content product.id product.is_approved product.is_sold product.is_recently_sold %}

  <div id='product' class='row-fluid' itemscope itemtype="http://schema.org/Product">
    <div class='span8'>

      <div id='product-title'>
        <div id='pinterest-button'>
          <a href="{{ product.pinterest_url }}"
             data-pin-do="buttonPin" data-pin-config="none">
            <img src="//assets.pinterest.com/images/pidgets/pin_it_button.png" />
          </a>
        </div>

        <h1 itemprop="name">
          {{ product.name }}
          by
          <a href="{% url 'store' product.seller.id %}">
            {{ product.seller.name }}
          </a>
        </h1>
      </div>

      <div id='photos' class='carousel slide'>
        <ol class='carousel-indicators'></ol>
        <!-- Carousel items -->
        <div class='carousel-inner'>
          {% for photo in product.photos.all %}
            <div class='item {% if forloop.first %}active{% endif %}'>
              <img src='{{ photo.product_size }}'
                   alt='{{ product.title }}'
                   {% if forloop.first %}itemprop="image"{% endif %}>
              <!--<div class='carousel-caption'></div>-->
            </div>
          {% endfor %}
        </div>
        <!-- Carousel nav -->
        <a class="carousel-control left" href="#photos" data-slide="prev">&lsaquo;</a>
        <a class="carousel-control right" href="#photos" data-slide="next">&rsaquo;</a>
      </div>

      <div id='pinkies' class='visible-desktop'>
        <ul class='thumbnails'>
          {% for photo in product.photos.all %}
            <li>
              <img class='thumbnail {% if forloop.first %}active{% endif %}'
                   data-target='#photos' data-slide-to='{{ forloop.counter0 }}'
                   src='{{ photo.pinky_size }}'>
            </li>
          {% endfor %}
        </ul>
      </div>

      <div id='product-description'>
        <p itemprop="description">
          {% if product.description %}
            {{ product.description }}
          {% else %}
            {{ product.title_description }}
          {% endif %}
        </p>

        {% if product.english_dimensions %}
          <p>
            <span class='title'>Approx. Size</span>
            <span class='nowrap'>{{ product.english_dimensions }}</span>
            <span class='title'>or</span>
            <span class='nowrap'>{{ product.metric_dimensions }}</span>
          </p>
        {% endif %}
      </div>

    </div>
    <!--
    <div id='ratings' class='span4 well well-small'>
      {% for rating in '123' %}
        <div class='rating'>
          {% for star in '12345' %}
            <i class="icon-star-empty"></i>
          {% endfor %}
          <span class='rating-subject'>Rating Subject</span>
        </div>
      {% endfor %}
    </div>
    -->

    <div id='actions' class='span4'>
      <table id='buying-table'>

        <tr id='faceboook' class='text-center' style='margin: 1em 1em 0;'>
          <div class="fb-like visible-desktop"
               data-href="http://www.theanou.com{{ product.get_absolute_url }}"
               data-width="250" data-layout="standard"
               data-show-faces="false" data-send="true">
          </div>
          <div class="fb-like visible-tablet"
               data-href="http://www.theanou.com{{ product.get_absolute_url }}"
               data-width="100" data-layout="button_count"
               data-show-faces="false" data-send="true">
          </div>
        </tr>

        <tr itemprop="offers" itemscope itemtype="http://schema.org/Offer">
          <td rowspan=2 class='price' itemprop="price">
            ${{ product.display_price }}
          </td>
          <td class='price-qualifier nowrap'>free shipping.</td>
        </tr>
        <tr>
          <td class='price-qualifier nowrap'>free returns.</td>
        </tr>
      </table>

      {% if product.is_sold or not product.is_approved %}
        <a id='buy-button' class='btn btn-primary btn-danger disabled'>
          <h2>
            {% if product.is_recently_sold %}
              Oh shoot, someone just bought it!
            {% elif product.is_sold %}
              Sold
            {% else %}
              Sorry, unavailable at this time
            {% endif %}
          </h2>
        </a>
      {% else %}
        <a id='buy-button' class='btn btn-primary btn-success'
           href="{% url 'cart-add' product.id %}">
          <h2>Add To Cart</h2>
        </a>
      {% endif %}
    </div>

    <div id='artisan' class='span4'>
      <img id='artisan-image' src='{{ product.artisan.image.thumb_size }}'
           alt='{{ product.artisan.title }}'>
      {% if product.artisan.name %}
        <p>handmade by</p>
        <h3 id='artisan-name'>{{ product.artisan.name }}</h3>
        <p>at</p>
      {% else %}
        <p>handmade at</p>
      {% endif %}
      <h3 id='store-name'>
        <a href="{% url 'store' product.seller.id %}">
          {{ product.seller.name }}
        </a>
      </h3>
      <p id='artisan-bio'>
        {% if product.artisan.description %}
          <span class='short-description'>
            {{ product.artisan.description|truncatewords:20 }}
          </span>
          {% ifnotequal product.artisan.description|truncatewords:20|length product.artisan.description|length %}
            <small class='read-more'>read more</small>
            <span class='long-description'>
              {{ product.artisan.description }}
            </span>
          {% endifnotequal %}
        {% endif %}
      </p>
    </div>

  </div>

  {% if product.utilities %}
    <h4 class='utilities-disclaimer'>
      This original item was uniquely handmade using the local materials and tools below
    </h4>
  {% endif %}

  <div id='utilities'><div class='row-fluid'>
    {% for utility in product.utilities %}
      <div class='utility span6'>
        <table>
          <tr>
            <td class='utility-image-space'>
              {% if utility.image %}
                <img class='small-utility-image' src='{{ utility.image.pinky_size }}'
                     alt='{{ utility.title }}'>
              {% endif %}
            </td>
            <td>
              {% if utility.name %}
                <h4>{{ utility.name }}</h4>
              {% endif %}

              {% if utility.description %}
                <p class='utility-description'>
                  <span class='short-description'>
                    {{ utility.description|truncatewords:15 }}
                  </span>
                  {% ifnotequal utility.description|truncatewords:15|length utility.description|length %}
                    <small class='read-more'>read more</small>
                    <span class='long-description'>
                      {{ utility.description }}
                    </span>
                  {% endifnotequal %}
                </p>
              {% endif %}
            </td>
          </tr>
        </table>
      </div>

      {% cycle "" "</div><div id='utilities' class='row-fluid'>"%}

    {% endfor %}

{% endcache public_product_content %}

{% cache 86400 public_product_extras product.id %}
  </div></div>
  <hr>

  {% load home_inclusion_tags %}
  <div id='store'>
    <h1 class='text-center'>
      <a href="{% url 'store' product.seller.id %}">
        <small>more from</small> {{ product.seller.name }}
      </a>
      {% if product.seller.image %}
        <img src='{{ product.seller.image.pinky_size }}'
             alt='{{ product.seller.title }}'>
      {% endif %}
    </h1>

    <div class='product-row row-fluid'>
      {% for product in more_products %}

        <div class='span4 product-area {% cycle "pos1" "pos2" "pos3" %}'>
          {% product_tag product %}
        </div>

        {% cycle "" "" "</div><div class='product-row row-fluid'>" %}
      {% endfor %}
    </div>
  </div>

{% endcache public_product_extras %}
{% endblock content %}
